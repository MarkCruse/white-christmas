<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Probability of a White Christmas</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.0/d3.min.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<script>
    // access token
    mapboxgl.accessToken = 'pk.eyJ1IjoibWRjcnVzZSIsImEiOiJjaXphYnhyaXMwMm1zMnFvOHVhanZtMGZ5In0.xnbrvIVE2IXBudC4OwuZtw';

    // Create a popup, but don't add it to the map yet.
    var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    // create a new map
    var map = new mapboxgl.Map({
        container: 'map', // container id
        // style: 'mapbox://styles/mapbox/dark-v9', // stylesheet location
        // style: 'mapbox://styles/mdcruse/cjb455y4au2p72rsua4gzn3cy',
        style: 'mapbox://styles/mapbox/outdoors-v10',
        center: [-98.35, 36.50],    //center on the continental center of US
        zoom: 4.2 // starting zoom
    });

    map.on('load', function () {

        // request our GEOJSON data
        d3.json('data/xmas_snow_stats_point_data.json', function (geojson) {
            // when loaded
            addLayer(geojson);
            addInteraction(geojson)
        });
    
        function addLayer(geojson) {
            map.addLayer({
                'id': 'snowStats',
                'type': 'circle',
                'source': {
                    'type': 'geojson',
                    'data': geojson // use the data as the data source}
                },
                // 'source-layer': 'points',  //???????????????
                'paint': {
                    // make circles larger as the user zooms from z12 to z22
                    'circle-radius': {
                        'base': 3,
                        'stops': [[4, 4], [7, 20]]
                    },
                    // color circles by snow_depth, using data-driven styles
                    'circle-color': {
                        "property": "Probability_of_Snow_Depth_GT_0",
                        "type": "exponential",
                        stops: [
                            [.1, "rgb(48, 88, 124)"],
                            [.25, "rgb(119,173,222)"],
                            [.4, "rgb(140, 185, 227)"],
                            [.6, "rgb(161,197,232)"],
                            [.75, "rgb(181,210,237)"],
                            [1, "rgb(202,222,242)"]]
                    }
                }
            });  // end addLayer point data
        }  
        function addInteraction(geojson) {
            //Use mousemove to track the geo location of the mouse pointer
            //the location is critical for the popup box

            map.on('mousemove', function (f) {
                // console.log(f);

                map.on('mouseenter', 'snowStats', function (e) {
                    var features = map.queryRenderedFeatures(e.point);
                    // console.log(e);
                    // console.log(e.features[0].properties.Name);
                    //console.log(e.features[0].properties.Probability_of_Snow_Depth_GT_0);

                    // Change the cursor style as a UI affordance.
                    map.getCanvas().style.cursor = 'pointer';

                    // Populate the popup based on the feature found. At the current coordinates.
                    popup.setLngLat(f.lngLat)
                        // .setHTML("Coordinates: " + (f.lngLat.lng) + ", " + (f.lngLat.lat) + " " + e.features[0].properties.ZONE)
                        // .setHTML('<font size="4">' + e.features[0].properties.Median_of_Snow_Depth_ > _0_(inches) + '</font>')
                        .setHTML('<font size="4">' + ((e.features[0].properties.Probability_of_Snow_Depth_GT_0) * 100).toLocaleString() + '% chance of a White Christmas' + '</font>')
                        .addTo(map);
                });

            });

            // Change cursor back to a pointer when mouse leaves snowStats
            // Turn off popip up mouse leaving snowStats
            map.on('mouseleave', 'snowStats', function () {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });
        }
    }); //end map load
</script>

</body>
</html>