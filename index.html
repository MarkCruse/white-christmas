<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Probability of a White Christmas</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://api.mapbox.com/mapbox-assembly/v0.19.0/assembly.min.css" rel="stylesheet">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.css' rel='stylesheet' />    <style>
     body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class='grid bg-gray-dark absolute h-full w-full'>
        <div class='col col--12 border-b border--white color-white'>
            <h1 class='txt-h2 mx36 my24 inline-block'>Probability of a White Christmas</h1>
            <p class='fr mr24 mt36'>Source:
                <!-- <a class='link' target='_blank' href='http://www.prism.oregonstate.edu/projects/plant_hardiness_zones.php'>USDA Plant Hardiness Zone GIS Datasets</a> -->
            </p>
        </div>
        <div class='col col--12 h-full relative'>
            <div id='map' class='w-full h-full'></div>
        </div>
    </div>
<script async defer src="https://api.mapbox.com/mapbox-assembly/v0.19.0/assembly.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.0/d3.min.js"></script>

<script>

    // access token
    mapboxgl.accessToken = 'pk.eyJ1IjoibWRjcnVzZSIsImEiOiJjaXphYnhyaXMwMm1zMnFvOHVhanZtMGZ5In0.xnbrvIVE2IXBudC4OwuZtw';

    // Create a popup, but don't add it to the map yet.
    var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    // create a new map
    var map = new mapboxgl.Map({
        container: 'map', // container id
        // style: 'mapbox://styles/mapbox/dark-v9', // stylesheet location
        // style: 'mapbox://styles/mdcruse/cjb455y4au2p72rsua4gzn3cy',
        style: 'mapbox://styles/mapbox/outdoors-v10',
        center: [-98.35, 36.50],    //center on the continental center of US
        zoom: 4.2 // starting zoom
    });

    map.on('load', function () {

        // request our GEOJSON data
        d3.json('data/xmas_snow_stats_point_data.json', function (geojson) {
            // when loaded
            addLayer(geojson);
            addInteraction(geojson)
        });

        map.fitBounds([-124.8, 24.53, -65.83, 49.38], {
            padding: {
                top: 10, bottom: 100, left: 20, right: 200
            }
        });
        // set the max bounds
        map.setMaxBounds(map.getBounds())
    
        function addLayer(geojson) {
            //console.log(geojson);
            //Add a layer for the point data
            map.addLayer({
                'id': 'snowStats',
                'type': 'circle',
                'source': {
                    'type': 'geojson',
                    'data': geojson // use the data as the data source}
                },
                // 'source-layer': 'points',  //???????????????
                'paint': {
                    // make circles larger as the user zooms from z12 to z22
                    'circle-radius': {
                        'base': 3,
                        'stops': [[4, 4], [7, 20]]
                    },
                    // color circles by snow_depth, using data-driven styles
                    'circle-color': {
                        "property": "Probability_of_Snow_Depth_GT_0",
                        "type": "exponential",
                        stops: [
                            [.05, "rgb(216,236,216)"],
                            [.25, "rgb(196,225,255)"],
                            [.4, "rgb(145,191,255)"],
                            [.6, "rgb(66,133,244)"],
                            [.75, "rgb(54, 109, 237)"],
                            [1, "rgb(37,95,219)"]]
                    },
                    "circle-stroke-color": "white",
                    "circle-stroke-width": .3,
                    "circle-opacity": {
                        "stops": [
                            [.05, 0],
                            [7, 1]
                        ]
                    }
                    // "circle-opacity": {
                    //     "stops": [
                    //         [0, 0],
                    //         [.05, 0],
                    //         [1, 1]
                    //     ]
                    // }
                }
            });  // end addLayer point data

            //Add a layer for the heatmap data
                    map.addLayer({
                        "id": "snow-heat",
                        "type": "heatmap",
                        'source': {
                            'type': 'geojson',
                            'data': geojson // use the data as the data source}
                        },
                        "maxzoom": 9,
                        "paint": {
                    //Increase the heatmap weight based on 
                    "heatmap-weight": {
                        // "property": "Probability_of_Snow_Depth_>_0",
                        "property": "Probability_of_Snow_Depth_GT_0",
                        "type": "exponential",
                        "stops": [
                            [0, 0],
                            [1, 6]
                        ]
                    },
                    //Increase the heatmap color weight weight by zoom level
                    //heatmap-intensity is a multiplier on top of heatmap-weight
                    "heatmap-intensity": {
                        "stops": [
                            [0, 1],
                            [9, 3]
                        ]
                    },
                    //Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
                    //Begin color ramp at 0-stop with a 0-transparancy color
                    //to create a blur-like effect.
                    "heatmap-color": [
                        "interpolate",
                        ["linear"],
                        ["heatmap-density"],
                        // 0, "rgb(81,98,128)",
                        0, "rgb(186,213,238)",
                        0.2, "rgb(209,227,243)",
                        0.4, "rgb(220,234,246)",
                        0.6, "rgb(232,241,249)",
                        0.8, "rgb(243,248,252)",
                        1, "rgb(246,246,246)"
                    ],
                    //Adjust the heatmap radius by zoom level
                    "heatmap-radius": {
                        "stops": [
                            [0, 2],
                            [9, 20]
                        ]
                    },
                    //Transition from heatmap to circle layer by zoom level
                    "heatmap-opacity": {
                        "default": 1,
                        "stops": [
                            [7, 1],
                            [9, 0]
                        ]
                    },
                }

            }); //end add layer heat

        }  
        function addInteraction(geojson) {
            //Use mousemove to track the geo location of the mouse pointer
            //the location is critical for the popup box

            map.on('mousemove', function (f) {
                // console.log(f);

                map.on('mouseenter', 'snowStats', function (e) {
                    var features = map.queryRenderedFeatures(e.point);

                    // Change the cursor style as a UI affordance.
                    map.getCanvas().style.cursor = 'pointer';

                    // Populate the popup based on the feature found. At the current coordinates.
                    popup.setLngLat(f.lngLat)
                        .setHTML('<font size="4">' + ((e.features[0].properties.Probability_of_Snow_Depth_GT_0) * 100).toLocaleString() + '% chance of a White Christmas' + '</font> <font size = "2" ><br /><br />Click point for weather station information</font>')
                        .addTo(map);
                });

                map.on('click', 'snowStats', function (e) {
                    var features = map.queryRenderedFeatures(e.point);

                    // Change the cursor style as a UI affordance.
                    map.getCanvas().style.cursor = 'pointer';

                    // Populate the popup based on the feature found. At the current coordinates.
                    popup.setLngLat(f.lngLat)
                      .setHTML('<font size="2"><b>' + e.features[0].properties.Name + ' - ' + e.features[0].properties.State  + '</b><br />Elevation: <b>' + e.features[0].properties.Elev + ' ft </b><br />' +
                             'Probability of Snow Depth > 0: <b>' + ((e.features[0].properties.Probability_of_Snow_Depth_GT_0) * 100).toLocaleString() + '% </b><br />' + 
                             'Median Snow Depth > 0: <b>' + e.features[0].properties.Median_of_Snow_Depth_GT_0_inches + '</b><br />' + 
                             'Probability of Snowfall > 1": <b>' + ((e.features[0].properties.Probability_of_Snowfall_GT_0) * 100).toLocaleString() + '% </b><br />' +
                             'Median Snowfall > 1": <b>' + e.features[0].properties.Median_of_Snowfall_GT_0_inches + '</b></font>')
                        .addTo(map);
                });
            });

            // Change cursor back to a pointer when mouse leaves snowStats
            // Turn off popup when mouse leaves snowStats
            map.on('mouseleave', 'snowStats', function () {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });
        }
    }); //end map load

</script>

</body>
</html>